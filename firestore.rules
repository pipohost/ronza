
/**
 * @description This ruleset enforces a strict user-ownership model for user profiles and reseller accounts.
 * Chat rooms and associated data (messages, banned users, registered members) have owner-based and role-based access control.
 * Public read access is granted to posts and comments, with owner-only write access for posts.
 * @dataStructure
 * - /users/{userId}: User profile data, accessible only to the user themselves.
 * - /chat_rooms/{chatRoomId}: Chat room metadata, with access control based on ownership and user roles.
 * - /chat_rooms/{chatRoomId}/messages/{messageId}: Messages within a chat room, with access control based on chat room membership.
 * - /chat_rooms/{chatRoomId}/privateMessages/{conversationId}/messages/{messageId}: Private Messages within a chat room, with access control based on participants.
 * - /chat_rooms/{chatRoomId}/bannedUsers/{userId}: Banned users for a specific chat room, managed by chat room owners.
 * - /chat_rooms/{chatRoomId}/users/{userId}: Users currently in a specific chat room. Data in this collection mirrors /users/{userId} data, which is accessible to the user themselves.
 * - /chat_rooms/{chatRoomId}/registeredMembers/{memberId}: Registered members for a specific chat room, managed by chat room owners.
 * - /reserved_names/{reservedNameId}: Reserved names, managed by resellers.
 * - /resellers/{resellerId}: Reseller accounts, accessible only to the reseller themselves.
 * - /resellers/{resellerId}/bannedUsers/{userId}: Users banned from a reseller's rooms, managed by the reseller.
 * - /roles_admin/{userId}: Indicates admin privileges for a user.
 * - /posts/{postId}: Journal posts, publicly readable, owner-only write access.
 * - /posts/{postId}/comments/{commentId}: Comments for a specific post, publicly readable, no write access control enforced.
 * - /global_bans/{userId}: Users who are banned from all rooms.
 * - /visitor_logs/{logId}: Logs of visitors joining rooms.
 * @keySecurityDecisions
 * - User listing is disallowed.
 * - All write operations require authentication.
 * - Public read access is granted to posts and comments.
 * - Roles admin collection provides a means of bestowing admin privileges.
 * @denormalizationForAuthorization
 * - Chat room messages do not contain the user's ID, requiring an extra lookup to `/users/{userId}` for authorization. This could be improved by denormalizing the user ID onto the message.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the authenticated user is an admin.
      */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isRoomModerator(roomId) {
        let userDoc = get(/databases/$(database)/documents/chat_rooms/$(roomId)/users/$(request.auth.uid));
        return userDoc.data.role == 'admin' || userDoc.data.role == 'superadmin' || userDoc.data.role == 'special' || userDoc.data.cosmeticRole == 'mythical_admin';
    }

    /**
     * @description Checks if the authenticated user is the owner of existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Global Ban: Stores users who are banned from all rooms.
     * @path /global_bans/{userId}
     * @allow (create) - Denied - Only server-side code can add global bans.
     * @deny (create) - Any client attempt to create a ban.
     * @allow (get) - Admins can read global bans.
     * @deny (get) - Non-admins cannot read global bans.
     * @principle Restrict global ban creation to server-side code, require admin role for read access.
     */
    match /global_bans/{userId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

     /**
      * @description Visitor Logs: Logs of visitors joining rooms.
      * @path /visitor_logs/{logId}
      * @allow (create) - Only server-side code can create visitor logs.
      * @deny (create) - Any client attempt to create a log.
      * @allow (get) - Admins can read visitor logs.
      * @deny (get) - Non-admins cannot read visitor logs.
      * @principle Restrict visitor log creation to server-side code, require admin role for read access.
      */
     match /visitor_logs/{logId} {
         allow get: if isAdmin();
         allow list: if isAdmin();
         allow create: if false;
         allow update: if false;
         allow delete: if false;
     }

    /**
     * @description User profiles.
     * @path /users/{userId}
     * @allow (create) if the user ID in the path matches the authenticated user ID.
     * @deny (create) if the user ID in the path does not match the authenticated user ID.
     * @allow (get, update, delete) if the user ID in the path matches the authenticated user ID.
     * @deny (get, update, delete) if the user ID in the path does not match the authenticated user ID.
     * @principle Enforces document ownership for all reads and writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Chat room metadata.
     * @path /chat_rooms/{chatRoomId}
     * @allow (get, list) if the chat room is public or the user is the owner.
     * @deny (get, list) if the chat room is private and the user is not the owner.
     * @allow (update, delete) if the user is the owner.
     * @deny (update, delete) if the user is not the owner.
     * @principle Enforces ownership for creating, updating, and deleting chat rooms. Allows public read access for public chat rooms.
     */
    match /chat_rooms/{chatRoomId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Messages within a chat room.
     * @path /chat_rooms/{chatRoomId}/messages/{messageId}
     * @allow (get, list) if the chat room is public or the user is a member of the room.
     * @allow (create) if the user is authenticated and in the room.
     * @allow (delete) if the user is a moderator of the room.
     * @principle Enforces chat room membership for message access. Prevents unauthorized message creation. Allows moderators to delete messages.
     */
    match /chat_rooms/{chatRoomId}/messages/{messageId} {
      allow get, list: if exists(/databases/$(database)/documents/chat_rooms/$(chatRoomId)/users/$(request.auth.uid));
      allow create: if isSignedIn() && exists(/databases/$(database)/documents/chat_rooms/$(chatRoomId)/users/$(request.auth.uid));
      allow update: if false;
      allow delete: if isSignedIn() && isRoomModerator(chatRoomId);
    }
    
    /**
     * @description Private Messages collection group.
     * @path /chat_rooms/{chatRoomId}/privateMessages/{conversationId}/messages/{messageId}
     * @allow (get, list, create) if the user is a participant in the conversation.
     * @deny (update, delete) all client-side updates and deletes.
     * @principle Only participants can read or write messages in a private conversation.
     */
    match /chat_rooms/{chatRoomId}/privateMessages/{conversationId}/messages/{messageId} {
        allow get, list: if isSignedIn() && request.auth.uid in conversationId.split('_');
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.fromId && request.auth.uid in request.resource.data.participantIds;
        allow update, delete: if false;
    }

    /**
     * @description Banned users for a specific chat room.
     * @path /chat_rooms/{chatRoomId}/bannedUsers/{userId}
     * @allow (get, list) never.
     * @allow (create, update, delete) if the user is the owner of the chat room.
     * @deny (create, update, delete) if the user is not the owner of the chat room.
     * @principle Enforces chat room ownership for managing banned users.
     */
    match /chat_rooms/{chatRoomId}/bannedUsers/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Users currently in a specific chat room.
     * @path /chat_rooms/{chatRoomId}/users/{userId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn();
     * @allow delete: if isSignedIn();
     */
     match /chat_rooms/{chatRoomId}/users/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Registered members for a specific chat room.
     * @path /chat_rooms/{chatRoomId}/registeredMembers/{memberId}
     * @allow (get, list) if the chat room is public or the user is the owner of the chat room.
     * @deny (get, list) if the chat room is private and the user is not the owner.
     * @allow (create, update, delete) if the user is the owner of the chat room.
     * @deny (create, update, delete) if the user is not the owner of the chat room.
     * @principle Enforces chat room ownership for managing registered members.
     */
    match /chat_rooms/{chatRoomId}/registeredMembers/{memberId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Reserved names.
     * @path /reserved_names/{reservedNameId}
     * @allow (get, list) if the user is authenticated.
     * @deny (get, list) if the user is not authenticated.
     * @allow (create, update, delete) if the user is a reseller and the reseller ID matches the `reseller` field.
     * @deny (create, update, delete) if the user is not a reseller or the reseller ID does not match.
     * @principle Enforces reseller ownership for managing reserved names.
     */
    match /reserved_names/{reservedNameId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Reseller accounts.
     * @path /resellers/{resellerId}
     * @allow (get, update, delete) if the user ID in the path matches the authenticated user ID.
     * @deny (get, update, delete) if the user ID in the path does not match the authenticated user ID.
     * @allow (create) if the user ID in the path matches the authenticated user ID.
     * @deny (create) if the user ID in the path does not match the authenticated user ID.
     * @principle Enforces document ownership for all reads and writes.
     */
    match /resellers/{resellerId} {
        allow get: if isOwner(resellerId);
        allow list: if false;
        allow create: if isOwner(resellerId);
        allow update: if isExistingOwner(resellerId);
        allow delete: if isExistingOwner(resellerId);
    }

    /**
     * @description Users banned from a reseller's rooms.
     * @path /resellers/{resellerId}/bannedUsers/{userId}
     * @allow (get, list) never.
     * @allow (create, update, delete) if the user is the reseller.
     * @deny (create, update, delete) if the user is not the reseller.
     * @principle Enforces reseller ownership for managing banned users.
     */
    match /resellers/{resellerId}/bannedUsers/{userId} {
        allow get: if false;
        allow list: if false;
        allow create: if isOwner(resellerId);
        allow update: if isOwner(resellerId);
        allow delete: if isOwner(resellerId);
    }

    /**
     * @description Documents in this collection denote admin privileges for a user. Existence implies admin role.
     * @path /roles_admin/{userId}
     * @allow (get) if the user is an admin.
     * @deny (get) if the user is not an admin.
     * @allow (create) if the user is an admin.
     * @deny (create) if the user is not an admin.
     * @allow (update) never.
     * @allow (delete) if the user is an admin.
     * @deny (delete) if the user is not an admin.
     * @principle Admin role management.
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if isAdmin();
    }

    /**
     * @description Journal posts.
     * @path /posts/{postId}
     * @allow (get, list) public read access.
     * @allow (create) if the user is authenticated.
     * @deny (create) if the user is not authenticated.
     * @allow (update, delete) if the user is the author of the post.
     * @deny (update, delete) if the user is not the author of the post.
     * @principle Public read access with owner-only write access.
     */
    match /posts/{postId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
    }

    /**
     * @description Comments for a specific post.
     * @path /posts/{postId}/comments/{commentId}
     * @allow (get, list) public read access.
     * @allow (create) if the user is authenticated.
     * @deny (create) if the user is not authenticated.
     * @allow (update, delete) never.
     * @principle Public read access, authenticated users can create comments. No update/delete allowed.
     */
    match /posts/{postId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
    }
  }
}
